- type: serial
  steps:
  - name: mkdir_ssh
    service: web
    command: mkdir -p ${HOME}/.ssh

  - name: export_keys
    service: web
    command: echo '${PRIVATE_SSH_KEY}' >> '${HOME}/.ssh/id_rsa'

  - name: migrate
    service: web
    command: bash -c "while ! nc -w 1 -z db 5432; do sleep 0.1; done; ./api/manage.py migrate;"

  - name: test
    service: web
    command: bash -c "cd api && python manage.py test"

  - name: deploy
    service: web
    command: bash -c "ssh -o StrictHostKeyChecking=no skeeph@khabib.me  'cd /home/skeeph/code/foodapi && docker-compose down && git pull && docker-compose build --no-cache && docker-compose up -d'"